#include <SPI.h>
#include <max7456.h>
#include <IRremote.h>

#define MAX_ARRAY_SIZE 5
#define MIN_LAP_TIME 5000 // milliseconds

#define IR_EMITTER_AVAILABLE true
#define RACER_ID 9
#define MAX_BEST_TIME 999999999999999


class RollingArray
{
public:
  unsigned int Size;
  unsigned long BestLapTime = MAX_BEST_TIME;
  unsigned long TimeStamps[MAX_ARRAY_SIZE] = {0};
  RollingArray();
  void add(unsigned long t);
  String ToString();
  String BestTimeStr();
  String PrevTimeStr();
  String CurrentTimeStr();
}
;

int RECV_PIN = 11;
int SEND_PIN = 13;
int LED_PIN = 12;

IRrecv irrecv(RECV_PIN);
IRsend irsend;

decode_results results;

RollingArray laptimes;


Max7456 osd;
unsigned long counter = 0;
byte tab[]={0xC8,0xC9};

void AddTimestamp(unsigned long t)
{
  laptimes.add(t);
}

void SendIR2Beacon()
{
  // now we send back to the beacon for two seconds

  unsigned long end_time = millis()+2000; // 2 seconds
  while(millis() < end_time)  
  {
    // Keep sending our Code
    if(IR_EMITTER_AVAILABLE)
    {
      irsend.sendSony(RACER_ID,12);
      delayMicroseconds(50);
    }
    else
    {
      // add a simple delay
      delay(100);
    }
  }
}

void handleIRSensor()
{
  unsigned long time;
  if (irrecv.decode(&results)) {
    time = millis();
    AddTimestamp(time);
   
    SendIR2Beacon();
    
    irrecv.resume(); // Receive the next value
    irrecv.enableIRIn(); // Start the receiver
  }
}

void setup()
{
  SPI.begin();
  
  osd.init(10);
  osd.setDisplayOffsets(60,18);
  osd.setBlinkParams(_8fields, _BT_BT);
 
  osd.activateOSD();
  osd.printMax7456Char(0x01,0,1);
  osd.print("Hello world :)",1,3);
  osd.print("Current Arduino time :",1,4);

  osd.printMax7456Char(0xD1,9,6,true);
  osd.print("00'00\"",10,6);  
  osd.printMax7456Chars(tab,2,12,7);
  //pinMode(redLed,OUTPUT);
  //pinMode(greenLed,OUTPUT);
  
  //base time = 160ms,time on = time off.
  
  irrecv.enableIRIn(); // Start the receiver
}


void loop()
{
  counter = millis()/1000;
  
  osd.print(int(counter/60),10,6,2,0,false,true);
  osd.print(int(counter%60),13,6,2,0,false,true);
  
  delay(100);
  
  handleIRSensor();
}


/************* Rolling Array ******************/
RollingArray::RollingArray()
{
  Size = 0;
}

void RollingArray::add(unsigned long t)
{
    if(Size > 0)
    {
      // check if this can be added
      if(t - TimeStamps[Size-1] < MIN_LAP_TIME)
      {
        return; // cannot add this 
      }
    }
    
    if(Size >= MAX_ARRAY_SIZE)
    {
      //  we need to re-shuffle
      for(int i=0;i<Size-1;i++)
      {
        TimeStamps[i]=TimeStamps[i+1];
      }
      TimeStamps[Size-1]=t;
    }
    else
    {
      TimeStamps[Size++] = t;
    }
    
    // check for best time
    if(Size > 1)
    {
      // check to see if we have a new best time
      if((TimeStamps[Size-1]-TimeStamps[Size-2]) < BestLapTime)
      {
        BestLapTime = TimeStamps[Size-1]-TimeStamps[Size-2];
      }
    }
}

String RollingArray::BestTimeStr()
{
  String outStr = "";
  if(BestLapTime < MAX_BEST_TIME)
  {
    outStr = "Best ";
    unsigned long seconds = BestLapTime/1000;
    unsigned long deci = BestLapTime%1000;
    outStr += seconds;
    outStr += ":";
    outStr += deci;
  }
  return outStr;
}

String RollingArray::PrevTimeStr()
{
  String outStr = "";
  if(Size > 1)
  {
    outStr = "Prev ";
    unsigned long laptime = TimeStamps[Size-1] - TimeStamps[Size-2];
    unsigned long seconds = laptime/1000;
    unsigned long deci = laptime%1000;
    outStr += seconds;
    outStr += ":";
    outStr += deci;
  }
  return outStr;
}

String RollingArray::ToString()
{
  String outStr = "";
  if(BestLapTime < MAX_BEST_TIME)
  {
    outStr = "Best ";
    unsigned long seconds = BestLapTime/1000;
    unsigned long deci = BestLapTime%1000;
    outStr += seconds;
    outStr += ":";
    outStr += deci;
  }
  return outStr;
}
String RollingArray::CurrentTimeStr()
{
    String outStr = "";
  if(Size > 0)
  {
    outStr = "Curr ";
    unsigned long laptime = millis() - TimeStamps[Size-1];
    unsigned long seconds = laptime/1000;
    unsigned long deci = laptime%1000;
    outStr += seconds;
    outStr += ":";
    outStr += deci;
  }
  return outStr;
}
